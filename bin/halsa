#! /usr/bin/env node

const fs = require('fs')
const exec = require('child_process').execSync
const path = require('path')
const chalk = require('chalk')
const read = require('read-yaml')
const program = require('commander')
const package = require('../package')
const halsa = __dirname
const project = process.cwd()
const timestamp = require('log-timestamp')
const { copySync } = require('fs-extra')
const start = require('../src/start')

timestamp(() => {
  return `
    ${chalk.green(`[${new Date().toLocaleTimeString()}]`)}
  `.replace(/ PM| AM/g, '').trim()
})

const write = console.log

const info = (message) => {
  return `${chalk.cyan('[info]')} ${message}`
}
const done = (message) => {
  return `${chalk.green('[done]')} ${message}`
}
const error = (message) => {
  return `${chalk.red('[fail]')} ${message}`
}

program
  .usage('[command] [options]')
  .version(`Halsa CLI v${package.version}`, '-v, --version')

program
  .command('new')
  .usage('halsa new <project>')
  .description('Create new halsa project')
  .action((option) => {
    let directory = 'current'

    write(info(`Using Halsa CLI v${package.version}`))

    if (typeof option === 'object') {
      write(error('Please define <project name> to create project'))
      write(error(`Run ${chalk.bold('halsa --help')} to see a details`))

      process.exit(0)
    }

    if (option !== '.') {
      directory = option
    }

    const source = path.join(halsa, '../template')
    const target = path.join(project, option)

    write(info(`Create halsa project on ${chalk.bold(directory)} directory`))
    copySync(source, target)
    write(done(`Success create project on ${chalk.bold(directory)} directory`))
  })

program
  .command('start')
  .description('Run current project directory')
  .action((option) => {
    write(info(`Using Halsa CLI v${package.version}`))

    if (typeof option === 'object') {
      write(error('Please define <project name> to start project'))
      write(error(`Run ${chalk.bold('halsa --help')} to see a details`))

      process.exit(0)
    }

    const target = path.join(project, option)
    const config = path.join(target, 'halsa.yml')

    if (!fs.existsSync(config)) {
      write(error('Config file not found, please start halsa on valid directory'))
      write(error(`Run ${chalk.bold('halsa --help')} to see a details`))

      process.exit(0)
    }

    start(
      halsa,
      target,
      read.sync(config),
      write,
      info,
      done,
      error
    )
  })

program
  .command('deploy')
  .description('Deploy current project to Github Pages')
  .action((option) => {
    write(info(`Using Halsa CLI v${package.version}`))

    if (typeof option === 'object') {
      write(error('Please define <project name> to start project'))
      write(error(`Run ${chalk.bold('halsa --help')} to see a details`))

      process.exit(0)
    }

    const target = path.join(project, option)
    const config = path.join(target, 'halsa.yml')
    const git = path.join(target, '.git')

    if (!fs.existsSync(config)) {
      write(error('Config file not found, please start halsa on valid directory'))
      write(error(`Run ${chalk.bold('halsa --help')} to see a details`))

      process.exit(0)
    }

    if (!fs.existsSync(config)) {
      exec(`cd ${target} && git init ${target} && git remote add origin ${config['repository']}`)
    }

    // exec('git add .halsa')
    // exec('git commit -am "Latest deploy at ${new Date()}"')
    exec('git subtree push --prefix .halsa origin gh-pages')

    console.log('done')
  })

program.parse(process.argv)

if (program.args.length === 0) {
  console.log(`
  Welcome to Halsa CLI v${package.version},
  Use ${chalk.green.bold('halsa --help')} to show help message.
  `)
}